---
title: "M2.851 - Tipología y ciclo de vida de los datos Practica 2"
author: "Francisco Javier Melchor y Enrique Otero"
date: "04/01/2021"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Presentación
En esta práctica se elabora un caso práctico orientado a aprender a identificar los datos relevantes para un proyecto analítico y usar las herramientas de integración, limpieza, validación y análisis de las mismas. Para hacer esta práctica tendréis que trabajar en grupos de 2 personas. Tendréis que entregar un solo archivo con el enlace Github (https://github.com) donde se encuentren las soluciones incluyendo los nombres de los componentes del equipo. Podéis utilizar la Wiki de Github para describir vuestro equipo y los diferentes archivos que corresponden a vuestra entrega. Cada miembro del equipo tendrá que contribuir con su usuario Github. Aunque no se trata del mismo enunciado, los siguientes ejemplos de ediciones anteriores os pueden servir como guía:  
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;- Ejemplo: https://github.com/Bengis/nba-gap-cleaning  
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;- Ejemplo complejo (archivo adjunto).


# Competencias
En esta práctica se desarrollan las siguientes competencias del Máster de Data Science:  

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;A. Capacidad de analizar un problema en el nivel de abstracción adecuado a cada situación y aplicar las habilidades y conocimientos adquiridos para abordarlo y resolverlo.  

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;B.Capacidad para aplicar las técnicas específicas de tratamiento de datos (integración, transformación, limpieza y validación) para su posterior análisis.

# Objetivos
Los objetivos concretos de esta práctica son:  

|   1. __Aprender__ a aplicar los conocimientos adquiridos y su capacidad de resolución de problemas en entornos  
|   nuevos o poco conocidos dentro de contextos más amplios o multidisciplinares.  

|   2. __Saber__ identificar los datos relevantes y los tratamientos necesarios (integración, limpieza y validación)  
|   para llevar a cabo un proyecto analítico.  

|   3. __Aprender__ a analizar los datos adecuadamente para abordar la información contenida en los datos.  

|   4. __Identificar__ la mejor representación de los resultados para aportar conclusiones sobre el problema  
|   planteado en el proceso analítico.  

|   5. __Actuar__ con los principios éticos y legales relacionados con la manipulación de datos en Tipología y ciclo  
|   de vida de los datos Práctica 2 pág 2 función del ámbito de aplicación.  

|   6. __Desarrollar__ las habilidades de aprendizaje que les permitan continuar estudiando de un modo que  
|   tendrá que ser en gran medida autodirigido o autónomo.  

|   7. __Desarrollar__ la capacidad de búsqueda, gestión y uso de información y recursos en el ámbito de la ciencia  
|   de datos.  

# Descripción de la Práctica a realizar
El objetivo de esta actividad será el tratamiento de un dataset, que puede ser el creado en la práctica 1 o bien cualquier dataset libre disponible en Kaggle (https://www.kaggle.com). Algunos ejemplos de dataset con los que podéis trabajar son:  

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Red Wine Quality (https://www.kaggle.com/uciml/red-wine-quality-cortez-et-al-2009)  
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Titanic: Machine Learning from Disaster (https://www.kaggle.com/c/titanic)  

El último ejemplo corresponde a una competición activa de Kaggle de manera que, opcionalmente, podéis aprovechar el trabajo realizado durante la práctica para entrar en esta competición.

# Preguntas y desarrollo de respuestas
Siguiendo las principales etapas de un proyecto analítico, las diferentes tareas a realizar (y justificar) son las siguientes:  

## Pregunta 1. Descripción del dataset. ¿Por qué es importante y qué pregunta/problema pretende responder?
Para nuestra practica especifica hemos elegido el dataset asociado al ejemplo de Kaggle:  
__Titanic: Machine Learnin from Disaster__  

El hundimiento del Titanic es uno de los naufragios más trágicos de la historia.

El 15 de abril de 1912, durante su viaje inaugural, el RMS Titanic, ampliamente considerado "insumergible", se hundió tras chocar con un iceberg. Desafortunadamente, no había suficientes botes salvavidas para todos a bordo, lo que resultó en la muerte de 1502 de los 2224 pasajeros y la tripulación.

Si bien hubo algún elemento de suerte involucrado en sobrevivir, parece que algunos grupos de personas tenían más probabilidades de sobrevivir que otros.

En este desafío, se pide crear un modelo predictivo que responda a la pregunta: __"¿Qué tipo de personas tenían más probabilidades de sobrevivir?"__ utilizando datos de pasajeros (es decir, nombre, edad, sexo, clase socioeconómica, etc.). En términos de análitica se trata de un problema de __clasificación__, esto es, usar esas variables independientes para predecir la categoría a la que pertenece cada registro, o, dicho de otra manera, predecir si un pasajero dado va a sobrevivir o no.

El enlace de descarga de este ejemplo contiene tres ficheros:  

|   __train.csv__. Se trata del dataset _test_ sobre el que entrenamos a nuestros modelos de analítica.  
|   __test.csv__. Es el dataset donde probamos, con nuevos datos, nuestros modelos de analítica.  
|   Para este caso no se incluye el resultado (variable dependiente _Survived_) ya que es el objetivo  
|   del concurso.
|   __gender_submission.csv__. Contiene un ejemplo de como debe presentarse el formato de salida con el  
|   resultado de nuestros modelos. Se trata de un conjunto de predicciones que asumen que todas y solo  
|   mujeres sobreviven.  

Según los datos proporcionados en la web de Kaggle, las variables de los datasets son:  

| __Variable__ | __Definition__ | __Key__ | 
|:-------------|:---------------|:------- |
| __Survived__ | If passenger survived | 0 = No, 1 = Yes |
| __Pclass__ | Ticket Class | 1 = 1st, 2 = 2nd, 3 = 3rd |
| __Sex__ | Passenger Sex | |
| __Age__ | Passenger Age in years | |
| __SibSp__ | Number of sibings/spouses of the passenger aboard the Titanic | |
| __Parch__ | Number of parents/children of the passenger aboard the Titanic | |
| __Ticket__ | Ticket number | |
| __Fare__ | Passenger fare | |
| __Cabin__ | Cabin Number | |
| __Embarked__ | Port of Embarkation | |  

### Análisis exploratorio del dataset de entrenamiento.

```{r warning=FALSE,message=FALSE}
# Carga de Librerias
library(ggplot2)
library(arc)
library(ggcorrplot)
```

En esta sección realizamos una primera exploración del dataset incluido en el fichero __train.csv__

```{r}
# Cargamos el dataset train.csv en la variable ttc
ttc <- read.csv("/home/dsninja/DataScience/WorkAreas/RStudio/datasets/titanic_train.csv")
head(ttc)
str(ttc)
# Contamos con 891 observaciones de las 12 variables decritas al inicio de esta seccion. 
```

Para una visualizacion general de los datos, podemos representar graficamente los supervivientes agrupados por diversas variables.  

```{r}
# Por ejemplo, la frecuencia de supervivientes por Sexo
ggplot(as.data.frame(table(ttc$Survived, ttc$Sex)), aes(Var2, Freq, fill=Var1)) + 
  geom_bar(stat="identity") +
  scale_fill_discrete(name = "Passenger Survived?", labels = c("No", "Yes")) +
  ggtitle("Passenger Survival Frequency by Sex") +
  theme(plot.title = element_text(size = 20, hjust = 0.5)) +
  xlab("Passenger Sex") + ylab("Frequency")

# O la frecuencia de supervivientes por Clase
ggplot(as.data.frame(table(ttc$Survived, ttc$Pclass)), aes(Var2, Freq, fill=Var1)) + 
  geom_bar(stat="identity") +
  scale_fill_discrete(name = "Passenger Survived?", labels = c("No", "Yes")) +
  ggtitle("Passenger Survival Frequency by Class") +
  theme(plot.title = element_text(size = 20, hjust = 0.5)) +
  xlab("Passenger Class") + ylab("Frequency")

# O incluso la frecuencia de supervivientes por puerto de embarque
ggplot(as.data.frame(table(ttc$Survived, ttc$Embarked)), aes(Var2, Freq, fill=Var1)) + 
  geom_bar(stat="identity") +
  scale_fill_discrete(name = "Passenger Survived?", labels = c("No", "Yes")) +
  ggtitle("Passenger Survival by Port of Embarcation") +
  theme(plot.title = element_text(size = 20, hjust = 0.5)) +
  xlab("Passenger Port of Embarcation") + ylab("Frequency")

# Tambien por el grupo de Edad, aunque previamente debemos discretizar la variable Age 
# ya que es numerica continua.

ttc$AgeD <- discretize(ttc$Age, 
                       method = "cluster", breaks = 3, labels=c("Young", "MidAge", "Old"))

ggplot(as.data.frame(table(ttc$Survived, ttc$AgeD)), aes(Var2, Freq, fill=Var1)) + 
  geom_bar(stat="identity") +
  scale_fill_discrete(name = "Passenger Survived?", labels = c("No", "Yes")) +
  ggtitle("Passenger Survival by Age Group") +
  theme(plot.title = element_text(size = 20, hjust = 0.5)) +
  xlab("Passenger Age Group") + ylab("Frequency")

# Otra grafica interesante puede ser aquella que muestre la frecuencia de supervivencia 
# dependiendo de si el pasajero tenia familiares con el en el barco o viajaban solos

ggplot(as.data.frame(table(ttc$Survived, ttc$SibSp)), aes(Var2, Freq, fill=Var1)) + 
  geom_bar(stat="identity") +
  scale_fill_discrete(name = "Passenger Survived?", labels = c("No", "Yes")) +
  ggtitle("Passenger Survival by number of Siblings/Spouses") +
  theme(plot.title = element_text(size = 14, hjust = 0.5)) +
  xlab("Passenger number of siblings/Spouses") + ylab("Frequency")

ggplot(as.data.frame(table(ttc$Survived, ttc$Parch)), aes(Var2, Freq, fill=Var1)) + 
  geom_bar(stat="identity") +
  scale_fill_discrete(name = "Passenger Survived?", labels = c("No", "Yes")) +
  ggtitle("Passenger Survival by number of Parents/Children") +
  theme(plot.title = element_text(size = 14, hjust = 0.5)) +
  xlab("Passenger number of Parents/Children") + ylab("Frequency")

# O en general, si el pasajero tenia familia a bordo
ttc$PassengerFamily <- ifelse(ttc$SibSp != 0 | ttc$Parch != 0, 'FamilyOnBorad', "AlonePassenger") 
table(ttc$Survived, ttc$PassengerFamily)
ggplot(as.data.frame(table(ttc$Survived, ttc$PassengerFamily)), aes(Var2, Freq, fill=Var1)) + 
  geom_bar(stat="identity") +
  scale_fill_discrete(name = "Passenger Survived?", labels = c("No", "Yes")) +
  ggtitle("Passenger Survival by Family On Board") +
  theme(plot.title = element_text(size = 14, hjust = 0.5)) +
  xlab("Passenger Family On Board") + ylab("Frequency")

# Por ultimo una relacion interesante, es la frecuencia de supervicencia asociada
# a la longitud del nombre del pasajero, bajo una premisa inicial de que, cuanto
# mas largo fuera el nombre, el pasajero podria tener una clase social mas elevada
ttc$NameLength <- vector("numeric", nrow(ttc))
for (i in 1:nrow(ttc)) {
  ttc$NameLength[i] <- nchar(as.character(ttc$Name)[i])
}
ttc$NameLengthD <- discretize(ttc$NameLength, 
           method = "cluster", breaks = 4, labels=c("ShortName (<21)", 
                                                    "MediumName (<28)", 
                                                    "LongName (<40)", 
                                                    "VeryLongName (<82)"))
ggplot(as.data.frame(table(ttc$Survived, ttc$NameLengthD)), aes(Var2, Freq, fill=Var1)) + 
  geom_bar(stat="identity") +
  scale_fill_discrete(name = "Passenger Survived?", labels = c("No", "Yes")) +
  ggtitle("Passenger Survival by Name Length") +
  theme(plot.title = element_text(size = 20, hjust = 0.5)) +
  xlab("Passenger Name Length, number of characters") + ylab("Frequency")
```

Tambien podemos representar los Histrogramas de las variables numericas continuas del dataset.

```{r}
# Histograma para la variable Age
ggplot(ttc, aes(x = Age)) + 
  geom_histogram(aes(y = ..density..)) +
  geom_density(alpha = 0.1, fill = "blue") + 
  ggtitle("Passengers Age Density Histogram") +
  theme(plot.title = element_text(size = 20, hjust = 0.5))

# Histograma para la variable SibSp
ggplot(ttc, aes(x = SibSp)) + 
  geom_histogram(aes(y = ..density..)) +
  geom_density(alpha = 0.1, fill = "green") + 
  ggtitle("Passengers sibings/spouses Density Histogram") +
  theme(plot.title = element_text(size = 20, hjust = 0.5))

# Histograma para la variable Parch
ggplot(ttc, aes(x = Parch)) + 
  geom_histogram(aes(y = ..density..)) +
  geom_density(alpha = 0.1, fill = "darkred") + 
  ggtitle("Passengers parents/children Density Histogram") +
  theme(plot.title = element_text(size = 20, hjust = 0.5))

# Histograma para la variable Fare
ggplot(ttc, aes(x = Fare)) + 
  geom_histogram(aes(y = ..density..)) +
  geom_density(alpha = 0.1, fill = "yellow") + 
  ggtitle("Passengers paid Fare Density Histogram") +
  theme(plot.title = element_text(size = 20, hjust = 0.5))
```

Los diagramas de boxplots de las variables numericas tambien son significativos, sobre todo para la deteccion de outliers:

```{r}
# Boxplot para la variable Age
# Esta variable, ademas de outliers, posee 177 registros NAs
summary(ttc$Age)
ggplot(data = ttc, aes(y = Age)) +
  geom_boxplot(outlier.colour = "red") +
  scale_x_discrete(guide = guide_axis(n.dodge = 2)) +
  ggtitle("Passenger Age Boxplot") +
  theme(plot.title = element_text(size = 20, hjust = 0.5))

# Boxplot para la variable SibSp
summary(ttc$SibSp)
ggplot(data = ttc, aes(y = SibSp)) +
  geom_boxplot(outlier.colour = "red") +
  scale_x_discrete(guide = guide_axis(n.dodge = 2)) +
  ggtitle("Passenger sibings/spouses Boxplot") +
  theme(plot.title = element_text(size = 20, hjust = 0.5))

# Boxplot para la variable Parch
summary(ttc$Parch)
ggplot(data = ttc, aes(y = Parch)) +
  geom_boxplot(outlier.colour = "red") +
  scale_x_discrete(guide = guide_axis(n.dodge = 2)) +
  ggtitle("Passenger parents/children Boxplot") +
  theme(plot.title = element_text(size = 20, hjust = 0.5))

# Boxplot para la variable Fare
summary(ttc$Fare)
ggplot(data = ttc, aes(y = Fare)) +
  geom_boxplot(outlier.colour = "red") +
  scale_x_discrete(guide = guide_axis(n.dodge = 2)) +
  ggtitle("Passenger paid Fare Boxplot") +
  theme(plot.title = element_text(size = 20, hjust = 0.5))
```

Por ultimo en el proceso de exploracion de los datos, se puede obtener una matriz de correlacion sobre las variables numericas del dataset:
```{r}
ttc_num <- subset(ttc, select=c(Age, SibSp, Parch, Fare))
ttccorr <- cor(ttc_num)
ggcorrplot(ttccorr, method = "circle")
```